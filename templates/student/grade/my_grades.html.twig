{% extends 'base.html.twig' %}

{% block title %}My Grades{% endblock %}

{% block body %}
<h1>My Grades</h1>

{% if enrollments %}
  {% for enrollment in enrollments %}
    <div class="card mb-4">
      <div class="card-header">
        <h5 class="mb-0">{{ enrollment.course.title }}</h5>
      </div>
      <div class="card-body">
        <p class="text-muted">{{ enrollment.course.description }}</p>
        
        {% set grades = enrollment.course.grades %}
        {% set studentGrades = [] %}
        
        {% for grade in grades %}
          {% if grade.student.id == app.user.id %}
            {% set studentGrades = studentGrades|merge([grade]) %}
          {% endif %}
        {% endfor %}

        {% if studentGrades %}
          <table class="table table-sm">
            <thead>
              <tr>
                <th>Type</th>
                <th>Grade</th>
                <th>Coefficient</th>
                <th>Date</th>
              </tr>
            </thead>
            <tbody>
              {% set totalWeighted = 0 %}
              {% set totalCoeff = 0 %}
              {% for grade in studentGrades %}
                <tr>
                  <td>{{ grade.type }}</td>
                  <td><strong>{{ grade.value }}/20</strong></td>
                  <td>{{ grade.coefficient }}</td>
                  <td>{{ grade.createdAt|date('Y-m-d') }}</td>
                </tr>
                {% set totalWeighted = totalWeighted + (grade.value * grade.coefficient) %}
                {% set totalCoeff = totalCoeff + grade.coefficient %}
              {% endfor %}
            </tbody>
          </table>
          
          {% if totalCoeff > 0 %}
            <p class="mt-3">
              <strong>Course Average:</strong> 
              <span class="badge bg-info">{{ (totalWeighted / totalCoeff)|round(2) }}/20</span>
            </p>
          {% endif %}
        {% else %}
          <p class="text-muted">No grades recorded yet.</p>
        {% endif %}
      </div>
    </div>
  {% endfor %}
{% else %}
  <div class="alert alert-info">
    You are not enrolled in any courses yet. <a href="{{ path('student_enrollment_available') }}">Browse courses</a>
  </div>
{% endif %}
{% endblock %}
